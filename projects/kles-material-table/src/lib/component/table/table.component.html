<form class="dynamic-form" [formGroup]="form" cdkScrollable>
  <table [id]="id" mat-table matSort [dataSource]="dataSource" [ngClass]="options.elevation | elevationPipe"
    formArrayName="rows" [trackBy]="trackById" [multiTemplateDataRows]="multiTemplate" cdkDropList
    (cdkDropListDropped)="drop($event)" [cdkDropListData]="this" [cdkDropListDisabled]="!dragDropRows"
    [cdkDropListAutoScrollStep]="dragDropRowsOptions.autoScrollStep" [cdkDropListSortPredicate]="sortPredicate()"
    [cdkDropListConnectedTo]="dragDropRowsOptions.connectedTo">
    <ng-container *ngFor="let column of columns;" [cdkColumnDef]="column.columnDef" [sticky]="column.sticky || false">

      <th mat-header-cell *matHeaderCellDef [klesResizeColumn]="column.resizable" class="{{column.class}}"
        [ngClass]="{'vertical-separator': options.verticalSeparator}">
        <div style="display: inline-flex;">
          <ng-container klesDynamicField [field]="column.headerCell" [group]="formHeader">
          </ng-container>
        </div>
      </th>
      <div>
        <!-- <td mat-cell *cdkCellDef="let row;let index = index;" klesCellStyle [row]="row" [column]="column" -->

        <ng-container *ngIf="multiTemplate else simpleTemplate">
          <td mat-cell *cdkCellDef="let row;let index = dataIndex;" [style]="getCellStyle(row,column)"
            [ngClass]="{'vertical-separator': options.verticalSeparator}">
            <ng-container klesDynamicCell [field]="column | fieldPipe:row.value._index" [group]="index | groupPipe"
              [siblingFields]="lineFields[index]" [column]="column" [config]="{templateUnfold}">
            </ng-container>
          </td>
        </ng-container>

        <ng-template #simpleTemplate>
          <td mat-cell *cdkCellDef="let row;let index = index;" [style]="getCellStyle(row,column)"
            [ngClass]="{'vertical-separator': options.verticalSeparator}">
            <ng-container klesDynamicCell [field]="column | fieldPipe:row.value._index" [group]="index | groupPipe"
              [siblingFields]="lineFields[row.value._index]" [column]="column" [config]="{templateUnfold}">
            </ng-container>
          </td>

        </ng-template>

        <td mat-footer-cell *matFooterCellDef [style]="getFooterStyle(column)">
          <ng-container *ngIf="column.footerCell" klesDynamicField [field]="column.footerCell" [group]="formFooter">
          </ng-container>
        </td>
      </div>

    </ng-container>


    <ng-container *ngIf="templateUnfold && multiTemplate">
      <ng-container *ngFor="let cell of templateUnfold.cells" [matColumnDef]="cell.name">
        <td mat-cell *matCellDef="let row;let index = dataIndex;" [attr.colspan]="cell.colspan"
          [attr.rowspan]="cell.rowspan" [ngClass]="{'vertical-separator': options.verticalSeparator}">
          <ng-container klesDynamicField [field]="cell" [group]="index | groupPipe"
            [siblingFields]="lineFields[row.value._index]">
          </ng-container>
        </td>
      </ng-container>
    </ng-container>

    <ng-container *ngFor="let template of templates">
      <ng-container *ngFor="let cell of template.cells" [matColumnDef]="cell.name">
        <td mat-cell *matCellDef="let row;let index = dataIndex;" [attr.colspan]="cell.colspan"
          [attr.rowspan]="cell.rowspan" [ngClass]="{'vertical-separator': options.verticalSeparator}">
          <ng-container klesDynamicField [field]="cell" [group]="index | groupPipe">
          </ng-container>
        </td>
      </ng-container>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns;sticky: true;"></tr>
    <tr mat-row [ngClass]="(row | rowPipe)" *matRowDef="let row; columns: displayedColumns;" (click)="onClick(row)"
      cdkDrag [cdkDragData]="row" [cdkDragDisabled]="(row | rowDragDisabledPipe)">

      <ng-template *ngIf="dragDropRowsOptions?.dragPreview?.component" cdkDragPreview [matchSize]="true">
        <ng-container klesComponent [component]="dragDropRowsOptions?.dragPreview?.component" [value]="row">
        </ng-container>
      </ng-template>

      <ng-template *ngIf="dragDropRowsOptions?.dragPlaceholder?.component" cdkDragPlaceholder>
        <ng-container klesComponent [component]="dragDropRowsOptions?.dragPlaceholder?.component" [value]="row">
        </ng-container>
      </ng-template>
    </tr>
    <ng-container *ngIf="multiTemplate">

      <ng-container *ngIf="templateUnfold">
        <tr mat-row
          *matRowDef="let row; columns: getTemplateColumns(templateUnfold); when: tableService.unfoldPredicate"></tr>
      </ng-container>

      <ng-container *ngFor="let template of templates">
        <tr mat-row [ngClass]="row | rowPipe"
          *matRowDef="let row; columns: getTemplateColumns(template); when: template.when"></tr>
      </ng-container>
    </ng-container>

    <div *ngIf="showFooter">
      <tr mat-footer-row *matFooterRowDef="displayedColumns;sticky: true">
      </tr>
    </div>
  </table>

</form>
<div [hidden]="hidePaginator">
  <mat-paginator #paginator [pageSize]="pageSize" [pageSizeOptions]="pageSizeOptions" [showFirstLastButtons]="true"
    (page)="pageChanged($event)">
  </mat-paginator>
</div>