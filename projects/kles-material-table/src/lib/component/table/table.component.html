<div [ngClass]="!options.fullsize ? (options.elevation | elevationPipe) : 'fullsize'" class="container-table">
  <form class="dynamic-form" [ngClass]="{fullsize: options.fullsize}" [formGroup]="form" cdkScrollable>
    <table [id]="id" mat-table matSort [dataSource]="dataSource" formArrayName="rows"
      [trackBy]="multiTemplate ? null : trackById" [multiTemplateDataRows]="multiTemplate" cdkDropList
      (cdkDropListDropped)="drop($event)" [cdkDropListData]="this" [cdkDropListDisabled]="!dragDropRows"
      [cdkDropListAutoScrollStep]="dragDropRowsOptions.autoScrollStep" [cdkDropListSortPredicate]="sortPredicate()"
      [cdkDropListConnectedTo]="dragDropRowsOptions.connectedTo">

      @for (column of columns(); track column.columnDef) {
      <ng-container [cdkColumnDef]="column.columnDef" [sticky]="column.sticky || false"
        [stickyEnd]="column.stickyEnd || false">
        <th mat-header-cell *matHeaderCellDef [klesResizeColumn]="column.resizable" class="{{column.ngClass}}"
          [ngClass]="{'vertical-separator': options.verticalSeparator}">

          <ng-container klesDynamicHeader [field]="column.headerCell" [group]="formHeader" [options]="options">
          </ng-container>

        </th>
        <div>
          @if (multiTemplate) {
          <td mat-cell *cdkCellDef="let row;let index = dataIndex;" [style]="getCellStyle(row,column)"
            [ngClass]="column | cellPipe">
            <ng-container klesDynamicCell [field]="column | fieldPipe:row.value._id" [group]="row.value._id | groupPipe"
              [siblingFields]="getSiblingFields(row)" [column]="column" [config]="{templateUnfold}">
            </ng-container>
          </td>
          }
          @else {
          <td mat-cell *cdkCellDef="let row;let index = index;" [style]="getCellStyle(row,column)"
            [ngClass]="column | cellPipe">
            <ng-container klesDynamicCell [field]="column | fieldPipe:row.value._id" [group]="row.value._id | groupPipe"
              [siblingFields]="getSiblingFields(row)" [column]="column" [config]="{templateUnfold}">
            </ng-container>
          </td>
          }

          <td mat-footer-cell *matFooterCellDef [style]="getFooterStyle(column)">
            @if (column.footerCell) {
            <ng-container klesDynamicField [field]="column.footerCell" [group]="formFooter">
            </ng-container>
            }
          </td>
        </div>
      </ng-container>
      }


      @if (templateUnfold && multiTemplate) {
      @for (cell of templateUnfold.cells; track cell.name) {
      <ng-container [matColumnDef]="cell.name">
        <td mat-cell *matCellDef="let row;let index = dataIndex;"
          [attr.colspan]="cell.colspan | spanPipe:displayedColumns().length" [attr.rowspan]="cell.rowspan"
          [ngClass]="{'vertical-separator': options.verticalSeparator}">
          <ng-container klesDynamicField [field]="cell" [group]="row.value._id | groupPipe"
            [siblingFields]="getSiblingFields(row)">
          </ng-container>
        </td>
      </ng-container>
      }
      }

      @for (template of templates; track template) {
      @for (cell of template.cells; track cell.name) {
      <ng-container [matColumnDef]="cell.name">
        <td mat-cell *matCellDef="let row;let index = dataIndex;"
          [attr.colspan]="cell.colspan | spanPipe: displayedColumns().length" [attr.rowspan]="cell.rowspan"
          [ngClass]="{'vertical-separator': options.verticalSeparator}">
          <ng-container klesDynamicField [field]="cell" [group]="row.value._id | groupPipe">
          </ng-container>
        </td>
      </ng-container>
      }
      }

      <tr mat-header-row *matHeaderRowDef="displayedColumns();sticky: true;"></tr>
      <tr mat-row [ngClass]="(row | rowPipe)" *matRowDef="let row; columns: displayedColumns();" (click)="onClick(row)"
        cdkDrag [cdkDragData]="row" [cdkDragDisabled]="(row | rowDragDisabledPipe)" [@rowsAnimation]="">

        @if (dragDropRowsOptions?.dragPreview?.component) {
        <ng-template cdkDragPreview [matchSize]="true">
          <ng-container klesComponent [component]="dragDropRowsOptions?.dragPreview?.component" [value]="row">
          </ng-container>
        </ng-template>
        }

        @if (dragDropRowsOptions?.dragPlaceholder?.component) {
        <ng-template cdkDragPlaceholder>
          <ng-container klesComponent [component]="dragDropRowsOptions?.dragPlaceholder?.component" [value]="row">
          </ng-container>
        </ng-template>
        }
      </tr>

      @if (multiTemplate) {
      @if (templateUnfold) {
      <tr mat-row [@rowsAnimation]=""
        *matRowDef="let row; columns: getTemplateColumns(templateUnfold); when: tableService.unfoldPredicate"></tr>
      }

      @for (template of templates; track template) {
      <tr mat-row [ngClass]="row | rowPipe" [@rowsAnimation]=""
        *matRowDef="let row; columns: getTemplateColumns(template); when: template.when"></tr>
      }
      }

      @if (showFooter) {
      <div>
        <tr mat-footer-row *matFooterRowDef="displayedColumns();sticky: true">
        </tr>
      </div>
      }
    </table>

  </form>
  <div [hidden]="hidePaginator">
    <mat-paginator #paginator [pageSize]="pageSize" [pageSizeOptions]="pageSizeOptions" [showFirstLastButtons]="true"
      (page)="pageChanged($event)">
    </mat-paginator>
  </div>
</div>
