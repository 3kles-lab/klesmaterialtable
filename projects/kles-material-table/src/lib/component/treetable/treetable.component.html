<form class="dynamic-form" [formGroup]="form" cdkScrollable>
    <table mat-table matSort [dataSource]="dataSource" [ngClass]="options.elevation | elevationPipe"
        formArrayName="rows" [trackBy]="multiTemplate ? null : trackById" cdkDropList (cdkDropListDropped)="drop($event)"
        [cdkDropListData]="this" [cdkDropListDisabled]="!dragDropRows" [multiTemplateDataRows]="multiTemplate"
        [cdkDropListAutoScrollStep]="dragDropRowsOptions.autoScrollStep" [cdkDropListSortPredicate]="sortPredicate()">
        <ng-container *ngFor="let column of columns;" [cdkColumnDef]="column.columnDef"
            [sticky]="column.sticky || false">

            <th mat-header-cell *matHeaderCellDef [klesResizeColumn]="column.resizable" class="{{column.class}}"
                [ngClass]="{'vertical-separator': options.verticalSeparator}">
                <div style="display: inline-flex;">
                    <ng-container klesDynamicField [field]="column.headerCell" [group]="formHeader">
                    </ng-container>
                </div>
            </th>

            <div *ngIf="column.visible">

                <ng-container *ngIf="multiTemplate else simpleTemplate">
                    <ng-container *cdkCellDef="let row;let index = dataIndex;">
                        <td mat-cell [style]="getCellStyle(row,column)"
                            [ngClass]="{'vertical-separator': options.verticalSeparator}">

                            <ng-container klesDynamicTreeCell [field]="column | fieldPipe:index"
                                [group]="index | groupPipe" [row]="row" [column]="column">
                            </ng-container>
                        </td>
                    </ng-container>
                </ng-container>

                <ng-template #simpleTemplate>
                    <ng-container *cdkCellDef="let row;let index = index;">
                        <td mat-cell [style]="getCellStyle(row,column)"
                            [ngClass]="{'vertical-separator': options.verticalSeparator}">

                            <ng-container klesDynamicTreeCell [field]="column | fieldPipe:index"
                                [group]="index | groupPipe" [row]="row" [column]="column">
                            </ng-container>
                        </td>

                    </ng-container>
                </ng-template>


                <ng-container *ngIf="templateUnfold && multiTemplate">
                    <ng-container *ngFor="let cell of templateUnfold.cells" [matColumnDef]="cell.name">
                        <td mat-cell *matCellDef="let row;let index = dataIndex;" [attr.colspan]="cell.colspan"
                            [attr.rowspan]="cell.rowspan" [ngClass]="{'vertical-separator': options.verticalSeparator}">
                            <ng-container klesDynamicField [field]="cell" [group]="index | groupPipe">
                            </ng-container>
                        </td>
                    </ng-container>
                </ng-container>



                <td mat-footer-cell *matFooterCellDef [style]="getFooterStyle(column)">
                    <ng-container *ngIf="column.footerCell" klesDynamicField [field]="column.footerCell"
                        [group]="formFooter">
                    </ng-container>
                </td>

            </div>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns;sticky: true;"></tr>

        <tr mat-row [ngClass]="row | rowTreePipe" [@rowsAnimation]=""
            *matRowDef="let row; columns: displayedColumns; when: isParent;" (click)="onClick(row)" cdkDrag
            [cdkDragData]="row" [cdkDragDisabled]="(row | rowDragDisabledPipe)">


            <ng-template *ngIf="dragDropRowsOptions?.dragPreview?.component" cdkDragPreview [matchSize]="true">
                <ng-container klesComponent [component]="dragDropRowsOptions?.dragPreview?.component" [value]="row">
                </ng-container>
            </ng-template>

            <ng-template *ngIf="dragDropRowsOptions?.dragPlaceholder?.component" cdkDragPlaceholder>
                <ng-container klesComponent [component]="dragDropRowsOptions?.dragPlaceholder?.component" [value]="row">
                </ng-container>
            </ng-template>
        </tr>


        <tr mat-row [ngClass]="row | rowTreePipe" [@rowsAnimation]=""
            *matRowDef="let row; columns: displayedColumns; when: isChild;" (click)="onClick(row)" cdkDrag
            [cdkDragData]="row" [cdkDragDisabled]="(row | rowDragDisabledPipe)">

            <ng-template *ngIf="dragDropRowsOptions?.dragPreview?.component" cdkDragPreview [matchSize]="true">
                <ng-container klesComponent [component]="dragDropRowsOptions?.dragPreview?.component" [value]="row">
                </ng-container>
            </ng-template>

            <ng-template *ngIf="dragDropRowsOptions?.dragPlaceholder?.component" cdkDragPlaceholder>
                <ng-container klesComponent [component]="dragDropRowsOptions?.dragPlaceholder?.component" [value]="row">
                </ng-container>
            </ng-template>
        </tr>

        <ng-container *ngIf="multiTemplate">

            <ng-container *ngIf="templateUnfold">
                <tr mat-row [@rowsAnimation]=""
                    *matRowDef="let row; columns: getTemplateColumns(templateUnfold); when: tableService.unfoldPredicate">
                </tr>
            </ng-container>

        </ng-container>


        <div *ngIf="showFooter">
            <tr mat-footer-row *matFooterRowDef="displayedColumns;sticky: true">
            </tr>
        </div>
    </table>

</form>
<div [hidden]="hidePaginator">
    <mat-paginator #paginator [pageSize]="pageSize" [pageSizeOptions]="pageSizeOptions" [showFirstLastButtons]="true">
    </mat-paginator>
</div>